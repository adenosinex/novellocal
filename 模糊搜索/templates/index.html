<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è¯­ä¹‰æœ - æ™ºèƒ½ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        [v-cloak] { display: none; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading-spinner {
            border: 2px solid #ffffff;
            border-top: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* å¢åŠ å¹³æ»‘è¿‡æ¸¡ */
        .smooth-transition { transition: all 0.3s ease; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen">
    
    <div id="app" v-cloak class="max-w-6xl mx-auto p-4 md:p-6">
        
        <header class="text-center mb-6">
            <h1 class="text-3xl font-extrabold text-indigo-600 tracking-tight cursor-default select-none">ğŸ” è¯­ä¹‰èµ„æºæœç´¢</h1>
            <p class="text-slate-500 text-sm mt-1">æ™ºèƒ½è®°å¿†é…ç½® Â· å®æ—¶å“åº”</p>
        </header>

        <div class="bg-white rounded-xl shadow-lg shadow-indigo-100/50 p-5 mb-6 border border-slate-100 sticky top-2 z-20">
            <div class="flex gap-3 mb-5">
                <input 
                    v-model="query" 
                    @input="debouncedSearch"
                    type="text" 
                    placeholder="è¾“å…¥æè¿°... å¦‚ï¼š'å¤ä»£ç©¿è¶Š' æˆ– '1080Pè§†é¢‘'" 
                    class="flex-1 p-3 pl-5 text-lg border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
                >
                <button 
                    @click="doSearch(1)"
                    :disabled="loading"
                    class="px-8 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 disabled:bg-slate-300 disabled:cursor-not-allowed transition-colors flex items-center gap-2 shadow-md active:scale-95 transform"
                >
                    <div v-if="loading" class="loading-spinner"></div>
                    <span>${ loading ? 'æ£€ç´¢ä¸­' : 'æœç´¢' }</span>
                </button>
            </div>

            <div class="flex flex-col md:flex-row gap-4 justify-between items-center text-sm text-slate-600 bg-slate-50 p-3 rounded-lg border border-slate-100">
                
                <div class="flex items-center gap-3 w-full md:w-auto overflow-x-auto pb-1 md:pb-0">
                    <span class="font-bold text-slate-400 uppercase text-xs flex-shrink-0">æ¥æº:</span>
                    {% for conf in config_list %}
                    <label class="flex items-center cursor-pointer hover:text-indigo-600 select-none whitespace-nowrap transition-colors">
                        <input type="checkbox" value="{{ conf.key }}" v-model="selectedTargets" class="w-4 h-4 text-indigo-600 rounded border-slate-300 mr-1.5 focus:ring-indigo-500">
                        {{ conf.name }}
                    </label>
                    {% endfor %}
                </div>

                <div class="flex items-center gap-4 w-full md:w-auto justify-end">
                    <div class="flex items-center gap-2">
                        <label>æ’åº:</label>
                        <select v-model="sortBy" class="bg-white border border-slate-200 py-1 px-2 rounded focus:outline-none focus:border-indigo-500 cursor-pointer hover:bg-slate-50">
                            <option value="score">ğŸ§  å…³è”åº¦</option>
                            <option value="date_desc">ğŸ“… æ—¶é—´ (æ–°â†’æ—§)</option>
                            <option value="size">ğŸ’¾ å¤§å°</option>
                            <option value="duration">â±ï¸ æ—¶é•¿</option>
                            <option value="resolution">ğŸ“º åˆ†è¾¨ç‡</option>
                        </select>
                    </div>

                    <div class="flex items-center gap-2" title="å…³è”åº¦ä½äºæ­¤å€¼çš„å°†è¢«éšè—">
                        <label>é˜ˆå€¼:</label>
                        <input type="range" min="0" max="100" v-model="minScore" @input="debouncedSearch" class="w-24 accent-indigo-600 cursor-pointer">
                        <span class="font-mono font-bold text-indigo-600 w-8 text-right">${ minScore }%</span>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="hasSearched" class="flex justify-between items-center px-2 mb-4 text-xs font-bold text-slate-400 uppercase tracking-widest smooth-transition">
            <span>Result: ${ total } (Time: ${ timeCost.toFixed(3) }s)</span>
            
            <div class="flex gap-2" v-if="total > 0">
                <button @click="changePage(-1)" :disabled="page <= 1" class="px-3 py-1 bg-white border border-slate-200 rounded hover:bg-slate-50 disabled:opacity-50 transition-colors">Prev</button>
                <span class="bg-indigo-50 text-indigo-600 px-3 py-1 rounded border border-indigo-100">${ page }</span>
                <button @click="changePage(1)" :disabled="results.length < pageSize" class="px-3 py-1 bg-white border border-slate-200 rounded hover:bg-slate-50 disabled:opacity-50 transition-colors">Next</button>
            </div>
        </div>

        <div class="space-y-4 pb-12">
            <div 
                v-for="(item, index) in results" 
                :key="item.id" 
                class="fade-in bg-white p-5 rounded-xl shadow-sm border-l-4 hover:shadow-md transition-all group relative"
                :class="item.type === 'video' ? 'border-purple-500' : 'border-indigo-500'"
            >
                <div class="flex justify-between items-start gap-4">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-[10px] px-1.5 py-0.5 rounded font-bold uppercase text-white tracking-wider"
                                  :class="item.type === 'video' ? 'bg-purple-500' : 'bg-indigo-500'">
                                ${ item.type }
                            </span>
                            
                            <h3 class="text-lg font-bold text-slate-800 truncate">
                                <a :href="buildStreamUrl(item.filename)" target="_blank" class="hover:text-indigo-600 transition-colors">
                                    ${ item.filename }
                                </a>
                            </h3>
                        </div>
                        
                        <div class="flex flex-wrap gap-2 text-xs text-slate-500 mb-3 items-center">
                            <span>ğŸ“… ${ item.mtime_str }</span>
                            <span class="bg-slate-100 px-2 py-0.5 rounded text-slate-600">ğŸ“‚ ${ item.source }</span>
                            
                            <template v-if="item.type === 'video'">
                                <span v-if="item.sort_size" class="bg-purple-50 text-purple-700 px-2 py-0.5 rounded font-medium border border-purple-100">
                                    ğŸ’¾ ${ item.sort_size.toFixed(1) } MB
                                </span>
                                <span v-if="item.sort_dur" class="bg-purple-50 text-purple-700 px-2 py-0.5 rounded font-medium border border-purple-100">
                                    â±ï¸ ${ formatDuration(item.sort_dur) }
                                </span>
                                <span v-if="item.sort_res" class="bg-purple-50 text-purple-700 px-2 py-0.5 rounded font-medium border border-purple-100">
                                    ğŸ“º ${ extractRes(item.preview) }
                                </span>
                            </template>
                        </div>

                        <p class="text-slate-600 text-sm leading-relaxed line-clamp-2 font-mono bg-slate-50 p-2 rounded border border-slate-100">
                            ${ item.preview }
                        </p>
                    </div>

                    <div class="flex flex-col items-center pl-4 border-l border-slate-100 border-dashed">
                        <span class="text-2xl font-black font-mono" 
                              :class="item.score > 0.6 ? 'text-indigo-600' : 'text-slate-400'">
                            ${ item.score_percent }<span class="text-sm text-slate-300">%</span>
                        </span>
                        <span class="text-[10px] text-slate-400">Match</span>
                    </div>
                </div>
            </div>

            <div v-if="hasSearched && results.length === 0" class="text-center py-16">
                <div class="text-5xl mb-4 opacity-30">ğŸŒªï¸</div>
                <p class="text-slate-500">æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ç»“æœ</p>
                <p class="text-slate-400 text-sm mt-1">è¯·å°è¯•é™ä½å…³è”åº¦é˜ˆå€¼æˆ–æ›´æ¢å…³é”®è¯</p>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue

        const app = createApp({
            data() {
                return {
                    query: '',
                    selectedTargets: [],
                    results: [],
                    total: 0,
                    timeCost: 0,
                    loading: false,
                    hasSearched: false,
                    
                    // é»˜è®¤å€¼
                    minScore: 40,
                    sortBy: 'score',
                    page: 1,
                    pageSize: 20,
                    
                    // é˜²æŠ–å®šæ—¶å™¨
                    debounceTimer: null
                }
            },
            // 1. åˆå§‹åŒ–æ—¶è¯»å–æœ¬åœ°å­˜å‚¨
            mounted() {
                this.loadPreferences();
                
                // å¦‚æœæœ¬åœ°æ²¡æœ‰è®°å½• selectedTargetsï¼Œåˆ™é»˜è®¤å…¨é€‰é¡µé¢ä¸Šçš„ checkbox
                if (this.selectedTargets.length === 0) {
                    this.$nextTick(() => {
                        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                        checkboxes.forEach(cb => {
                            this.selectedTargets.push(cb.value);
                        });
                        // å…¨é€‰åä¿å­˜ä¸€æ¬¡çŠ¶æ€
                        this.savePreferences();
                    });
                }
            },
            // 2. ç›‘å¬å…³é”®æ•°æ®å˜åŒ–ï¼Œå®ç°è‡ªåŠ¨ä¿å­˜å’Œè‡ªåŠ¨æœç´¢
            watch: {
                selectedTargets: {
                    handler() {
                        this.savePreferences();
                        this.doSearch(1); // åˆ‡æ¢åº“ç›´æ¥æœç´¢
                    },
                    deep: true
                },
                sortBy() {
                    this.savePreferences();
                    this.doSearch(1); // åˆ‡æ¢æ’åºç›´æ¥æœç´¢
                },
                // minScore å’Œ query é€šè¿‡ @input ç»‘å®šäº†é˜²æŠ–å‡½æ•°ï¼Œè¿™é‡Œä¸éœ€è¦ watch
                minScore() {
                    this.savePreferences();
                }
            },
            methods: {
                // è¯»å–é…ç½®
                loadPreferences() {
                    try {
                        const prefs = localStorage.getItem('ai_search_prefs');
                        if (prefs) {
                            const data = JSON.parse(prefs);
                            // æ¢å¤æ•°æ®ï¼Œä½¿ç”¨å¯é€‰é“¾é˜²æ­¢æ—§æ•°æ®ç¼ºå¤±æŠ¥é”™
                            if (data.selectedTargets) this.selectedTargets = data.selectedTargets;
                            if (data.minScore) this.minScore = data.minScore;
                            if (data.sortBy) this.sortBy = data.sortBy;
                            // ä¸æ¢å¤ queryï¼Œæ¯æ¬¡è¿›æ¥æœæ–°çš„æ¯”è¾ƒå¥½
                        }
                    } catch (e) {
                        console.error("è¯»å–é…ç½®å¤±è´¥", e);
                    }
                },
                // ä¿å­˜é…ç½®
                savePreferences() {
                    const prefs = {
                        selectedTargets: this.selectedTargets,
                        minScore: this.minScore,
                        sortBy: this.sortBy
                    };
                    localStorage.setItem('ai_search_prefs', JSON.stringify(prefs));
                },
                
                buildStreamUrl(filename) {
                    // æ–‡ä»¶å URL å®‰å…¨ç¼–ç 
                    const safeName = encodeURIComponent(filename);
                    // å‡è®¾è¿™æ˜¯ä½ çš„æµåª’ä½“æœåŠ¡åœ°å€
                    return `http://one4.zin6.site/videos/stream/name/${safeName}`;
                },
                
                // é˜²æŠ–æœç´¢ï¼šç”¨æˆ·è¿ç»­è¾“å…¥/æ‹–åŠ¨æ»‘å—æ—¶ï¼Œåªåœ¨åœæ­¢æ“ä½œ 400ms åè§¦å‘ä¸€æ¬¡æœç´¢
                debouncedSearch() {
                    if (this.debounceTimer) clearTimeout(this.debounceTimer);
                    this.debounceTimer = setTimeout(() => {
                        this.doSearch(1);
                    }, 400); // å»¶è¿Ÿ 400ms
                },

                async doSearch(page_num) {
                    // å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼Œæ¸…ç©ºç»“æœå¹¶è¿”å›ï¼Œä¸å‘è¯·æ±‚
                    if (!this.query.trim()) {
                        // å¯é€‰ï¼šæ¸…ç©ºç»“æœ
                        // this.results = [];
                        // this.hasSearched = false;
                        return;
                    }
                    
                    this.loading = true;
                    this.page = page_num || 1; 

                    try {
                        const res = await axios.post('/api/search', {
                            query: this.query,
                            targets: this.selectedTargets,
                            min_score: this.minScore / 100,
                            sort_by: this.sortBy,
                            page: this.page,
                            page_size: this.pageSize
                        });

                        if (res.data.status === 'success') {
                            this.results = res.data.results;
                            this.total = res.data.total;
                            this.timeCost = res.data.time;
                            this.hasSearched = true;
                            
                            // åªæœ‰ç¿»é¡µæ—¶æ‰æ»šåŠ¨åˆ°é¡¶éƒ¨ï¼Œè‡ªåŠ¨åˆ·æ–°æ—¶ä¸æ»šåŠ¨ï¼Œé¿å…å¹²æ‰°ç”¨æˆ·è§†çº¿
                            if (page_num !== this.page || (page_num === 1 && !this.debounceTimer)) {
                                window.scrollTo({ top: 0, behavior: 'smooth' });
                            }
                        }
                    } catch (e) {
                        // ç”Ÿäº§ç¯å¢ƒå¯ä»¥æ³¨é‡Šæ‰ alertï¼Œé¿å…æ‰“æ–­ç”¨æˆ·
                        console.error("Search error:", e);
                    } finally {
                        this.loading = false;
                    }
                },
                changePage(delta) {
                    const newPage = this.page + delta;
                    if (newPage > 0) this.doSearch(newPage);
                },
                formatDuration(seconds) {
                    if (!seconds) return '0s';
                    const m = Math.floor(seconds / 60);
                    const s = Math.floor(seconds % 60);
                    return `${m}m ${s}s`;
                },
                extractRes(preview) {
                    const match = preview.match(/Resolution:\s*(\d+x\d+)/);
                    return match ? match[1] : 'UNK';
                }
            }
        });

        // ä¿®æ”¹ Vue åˆ†éš”ç¬¦ï¼Œé¿å¼€ Jinja2
        app.config.compilerOptions.delimiters = ['${', '}'];
        
        app.mount('#app');
    </script>
</body>
</html>